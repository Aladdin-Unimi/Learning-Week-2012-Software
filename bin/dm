#!/usr/bin/env python

# Copyright (C) 2012 Massimo Santini <massimo.santini@unimi.it>
#
# This file is part of Learning-Week-2012-Software.
# 
# Learning-Week-2012-Software is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or (at your
# option) any later version.
# 
# Learning-Week-2012-Software is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the GNU General
# Public License for more details.
# 
# You should have received a copy of the GNU General Public License along with
# Learning-Week-2012-Software If not, see <http://www.gnu.org/licenses/>.


from json import load, loads, dump, dumps
from getpass import getpass
from io import StringIO
from mimetypes import guess_type
from os.path import expanduser, exists, getsize, basename
from subprocess import Popen, PIPE
from sys import argv 
from xml.dom.minidom import parseString

_, user, repo, path, desc = argv

def curl( args, data = None ):
	p = Popen( [ 'curl', '-s' ] + ( [ '-d', '@-' ] if data else [] ) + args, stdin = PIPE, stdout = PIPE )
	return p.communicate( dumps( data ) if data else None )[ 0 ]

tokens_path = expanduser( '~/.dmtokens' )
if exists( tokens_path ):
	with open( tokens_path, 'r' ) as f:
		tokens = load( f )
else:
	tokens = dict()

if not user in tokens:
	pwd = getpass()
	data = { "scopes": [ "user", "repo" ], "note": "Download Manager" }
	r = loads( curl( [ '-u', '{0}:{1}'.format( user, pwd ), 'https://api.github.com/authorizations' ], data ) )
	try:
		token = tokens[ user ] = r[ 'token' ]
	except KeyError:
		raise RuntimeError( 'Problem authenticationg' )
	with open( tokens_path, 'w' ) as f:
		dump( tokens, f )
	print 'Got token: ' + token
else:
	token = tokens[ user ]
	name = basename( path )
	content_type = guess_type( path )[ 0 ]
	data = { "name": name, "size": getsize( path ), "description": desc, "content_type": content_type }
	args = [
		'-H', 'Authorization: token {0}'.format( token ),
		'https://api.github.com/repos/{0}/{1}/downloads'.format( user, repo )
	]
	r = loads( curl( args, data ) )
	try:
		args = [
			'-F', 'key=downloads/{0}/{1}/{2}'.format( user, repo, name ), 
			'-F', 'acl={0}'.format( r[ 'acl' ] ),
			'-F', 'success_action_status=201',
			'-F', 'Filename={0}'.format( name ),
			'-F', 'AWSAccessKeyId={0}'.format( r[ 'accesskeyid' ] ),
			'-F', 'Policy={0}'.format( r[ 'policy' ] ),
			'-F', 'Signature={0}'.format( r[ 'signature' ] ),
			'-F', 'Content-Type={0}'.format( content_type ),
			'-F', 'file=@{0}'.format( path ),
			'https://github.s3.amazonaws.com/'
		]
	except KeyError:
		raise RuntimeError( 'Problems uploading' )
	print parseString( curl( args ) ).toprettyxml()
